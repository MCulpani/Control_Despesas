<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gest√£o de Despesas Operacionais</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
/* ===== LOGIN ORIGINAL ===== */
body { font-family: 'Inter', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
#login-area { max-width: 400px; margin: 6vh auto; padding: 50px 30px; background: #ffffff; border-radius: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.12); text-align: center; }
#login-area h2 { margin-bottom: 32px; font-weight: 600; color: #0f172a; font-size: 26px; }
.input-wrapper { position: relative; margin-bottom: 20px; }
.input-wrapper input { width: 100%; padding: 14px 45px 14px 16px; font-size: 15px; border: 1px solid #cbd5e1; border-radius: 12px; background: #f8fafc; color: #0f172a; box-sizing: border-box; transition: border 0.3s, box-shadow 0.3s; }
.input-wrapper i { position: absolute; top: 50%; right: 16px; transform: translateY(-50%); cursor: pointer; }
button.app-btn { padding: 10px 16px; border: 0; border-radius: 8px; background: #0ea5a4; color: white; cursor: pointer; font-weight: 600; }

/* ===== SISTEMA DE DESPESAS ORIGINAL ===== */
body.app{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:#e5e7eb}
header{background:#020617;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
header button{margin-left:6px;padding:8px 14px;border:none;border-radius:8px;background:#38bdf8;font-weight:bold;cursor:pointer}
main{padding:20px}
.card{background:#111827;border-radius:14px;padding:18px;margin-bottom:20px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:18px 20px;
}
.col-2{grid-column:span 2}
.col-3{grid-column:span 3}
label{
  font-size:13px;
  color:#9ca3af;
  margin-bottom:4px;
  display:block;
}
input,select,textarea{
  width:100%;
  height:40px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #374151;
  background:#020617;
  color:#e5e7eb;
  font-size:13px;
  box-sizing:border-box;
}
textarea{
  height:80px;
  resize:vertical;
}
button.action{margin-top:16px;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;font-size:13px;text-align:center}
th,td{padding:8px;border-bottom:1px solid #1f2933}
.badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:bold}
.ok{background:#14532d;color:#22c55e}
.pending{background:#422006;color:#facc15}
a{color:#38bdf8;text-decoration:none}
.btn-sm{padding:4px 8px;border:none;border-radius:6px;cursor:pointer;font-size:11px}
.edit{background:#2563eb;color:#fff}
.del{background:#dc2626;color:#fff}
.save{background:#16a34a;color:#fff}
.cancel{background:#6b7280;color:#fff}
</style>

<!-- Libs originais -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase Login -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyC_FD33WikHRUVCd2JtH_ok3WF1YtfAFhU",
  authDomain: "conversor-de-avisos.firebaseapp.com",
  projectId: "conversor-de-avisos",
  storageBucket: "conversor-de-avisos.firebasestorage.app",
  messagingSenderId: "1099286231450",
  appId: "1:1099286231450:web:94e0b02dec2ef6b0d26223"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

window.addEventListener("DOMContentLoaded",()=>{
  const loginBox = document.getElementById("login-area");
  const appBox = document.getElementById("app-area");
  const msgLogin = document.getElementById("login-msg");
  const emailInput = document.getElementById("email");
  const passInput  = document.getElementById("password");
  const btnLogin   = document.getElementById("btnLogin");
  const btnLogout  = document.getElementById("btnLogout");

  btnLogin.addEventListener("click", async () => {
    try {
      await signInWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value);
      msgLogin.textContent = "";
    } catch (err) {
      msgLogin.textContent = "Erro: " + err.message;
    }
  });

  btnLogout.addEventListener("click", async () => { await signOut(auth); });
  document.getElementById("togglePassword").addEventListener("click", () => {
    passInput.type = passInput.type === "password" ? "text" : "password";
  });

  onAuthStateChanged(auth, (user) => {
    loginBox.style.display = user ? "none" : "block";
    appBox.style.display = user ? "block" : "none";
    if(user) document.body.className="app";
  });
});
</script>
</head>

<body>

<!-- LOGIN -->
<div id="login-area">
  <h2>Entrar na Plataforma</h2>
  <div class="input-wrapper">
    <input id="email" type="email" placeholder="Email" />
    <i>üë§</i>
  </div>
  <div class="input-wrapper">
    <input id="password" type="password" placeholder="Senha" />
    <i id="togglePassword">üëÅÔ∏è</i>
  </div>
  <button id="btnLogin" class="app-btn" style="width:100%;">Entrar</button>
  <p id="login-msg"></p>
</div>

<!-- SISTEMA -->
<div id="app-area" style="display:none;">
<header>
  <h3>üìä Gest√£o de Despesas</h3>
  <div>
    <button onclick="mostrar('cadastro')">Nova</button>
    <button onclick="mostrar('despesas')">Despesas</button>
    <button id="btnLogout">Sair</button>
  </div>
  <div></div>
</header>

<main>

<button onclick="escolherPasta()">Escolher pasta de anexos</button>
<span id="pastaInfo" style="margin-left:10px;font-size:12px;color:#9ca3af"></span>  
  
<section id="cadastro" class="card">
<h3>Nova Despesa</h3>
<div class="grid">
<div>
  <label>Filial</label>
  <select id="filial">
    <option value="">Selecione</option>
    <option>JOI</option>
    <option>EAA</option>
    <option>RCO</option>
    <option>CAS</option>
    <option>CLM</option>
  </select>
</div>

<div>
  <label>Raz√£o Social Prestador</label>
  <input id="razao">
</div>

<div>
  <label>N√∫mero NF</label>
  <input id="nfUnico">
</div>

<div>
  <label>Quantidade de DT</label>
  <input type="number" id="qtdDT" min="1" oninput="gerarCamposDT()">
</div>

<div id="listaDT" class="col-2"></div>

<div>
  <label>UF</label>
  <input id="uf">
</div>
<div><label>Valor da NF-s</label><input id="valorNFS" oninput="formatarMoeda(this)"></div>
<div><label>Tipo de ve√≠culo</label>
<select id="tipoVeiculo">
<option>Truck</option>
<option>Carreta</option>
<option>Bitrem</option>
<option>N/A</option>
</select>
</div>
<div><label>Data Vencimento</label><input type="date" id="dataVencimento" onclick="this.showPicker()"></div>
<div class="col-2"><label>Cliente</label><input id="cliente"></div>
<div class="col-2">
<label>Tipo de Servi√ßo</label>
<select id="tipoServico">
<option>Taxa de Desembarque</option>
<option>Taxa de Embarque</option>
<option>Armazenagem</option>
<option>Travessia de Balsa</option>
<option>Descarga Manual</option>
<option>Redespacho</option>
<option>Descarga Maquin√°rio</option>
</select>
</div>
<div><label>Embutimento?</label>
<select id="embutimento">
<option>Sim</option>
<option>N√£o</option>
</select>
</div>
<div><label>Motivo?</label>
<select id="motivo">
<option>Sim</option>
<option>N√£o</option>
</select>
</div>
<div class="col-2">
<label>Fato gerador</label>
<select id="fatoGerador">
<option>Incid√™ncia Normal</option>
<option>Desacordo comercial</option>
<option>Falha Operacional TGL</option>
<option>Falha Operacional TIGRE</option>
<option>Indisponibilidade Cliente</option>
<option>Eventos At√≠picos</option>
</select>
</div> 
<div class="col-3"><label>Observa√ß√µes</label><input id="observacoes"></div>
<div><label>Status</label>
<select id="status">
  <option value="Pendente">Pendente</option>
  <option value="Aprovado">Aprovado</option>
</select>
</div>
<div><label>Nota Fiscal/Recibo</label><input type="file" id="nota"></div>
<div><label>Formul√°rio de Custo</label><input type="file" id="compPag"></div>
<div><label>Racional de Custo</label><input type="file" id="compNeg"></div>
</div>
<button class="action" style="background:#22c55e" onclick="salvar()">Salvar Despesa</button>
<button class="action" style="background:#38bdf8;margin-left:10px" onclick="novaDespesa()">Nova Despesa</button>
</section>

<section id="despesas" class="card" style="display:none">
<h3>Despesas Cadastradas</h3>
<div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; gap:10px">

  <!-- Bot√µes √† esquerda -->
  <div>
    <button onclick="exportarExcel()" style="margin-right:6px;padding:8px 14px;border:none;border-radius:8px;background:#22c55e;font-weight:bold;cursor:pointer">Exportar Excel</button>
    <button onclick="exportarPDF()" style="padding:8px 14px;border:none;border-radius:8px;background:#dc2626;color:#fff;font-weight:bold;cursor:pointer">Exportar PDF</button>
  </div>

 <!-- Total central -->
<div style="
  background:#020617;
  padding:10px 18px;
  border-radius:10px;
  min-width:220px;
  text-align:center;
  border:1px solid #14532d;
">
  <div style="
    font-size:12px;
    color:#9ca3af;
    margin-bottom:4px;
  ">
    Total Valor NF
  </div>
  <div id="totalValorNF" style="
    font-size:20px;
    font-weight:bold;
    color:#22c55e;
  ">
    R$ 0,00
  </div>
</div>
  
  <!-- Filtros √† direita -->
  <div style="display:flex; gap:8px; align-items:center">
   <div style="display:flex; flex-direction:column">
  <label style="font-size:11px;color:#9ca3af">Data in√≠cio</label>
  <input type="date" id="filtroDataIni" onclick="this.showPicker()" onchange="render()">
</div>

<div style="display:flex; flex-direction:column">
  <label style="font-size:11px;color:#9ca3af">Data fim</label>
  <input type="date" id="filtroDataFim" onclick="this.showPicker()" onchange="render()">
</div>
    
    <select id="filtroFilial" onchange="render()">
      <option value="">Filial</option>
      <option>JOI</option>
      <option>EAA</option>
      <option>RCO</option>
      <option>CAS</option>
      <option>CLM</option>
    </select>

   <select id="filtroServico" onchange="render()">
      <option value="">Servi√ßo</option>
      <option>Taxa de Desembarque</option>
      <option>Taxa de Embarque</option>
      <option>Armazenagem</option>
      <option>Travessia de Balsa</option>
      <option>Descarga Manual</option>
      <option>Redespacho</option>
      <option>Descarga Maquin√°rio</option>
    </select>

    <select id="filtroFato" onchange="render()">
      <option value="">Fato Gerador</option>
      <option>Incid√™ncia Normal</option>
      <option>Desacordo comercial</option>
      <option>Falha Operacional TGL</option>
      <option>Falha Operacional TIGRE</option>
      <option>Indisponibilidade Cliente</option>
      <option>Eventos At√≠picos</option>
    </select>

    <select id="filtroMes" onchange="render()">
  <option value="">M√™s</option>
  <option value="01">Janeiro</option>
  <option value="02">Fevereiro</option>
  <option value="03">Mar√ßo</option>
  <option value="04">Abril</option>
  <option value="05">Maio</option>
  <option value="06">Junho</option>
  <option value="07">Julho</option>
  <option value="08">Agosto</option>
  <option value="09">Setembro</option>
  <option value="10">Outubro</option>
  <option value="11">Novembro</option>
  <option value="12">Dezembro</option>
</select>

<select id="filtroQuinzena" onchange="render()">
  <option value="">Quinzena</option>
  <option value="1">1¬∞ quinzena</option>
  <option value="2">2¬∞ quinzena</option>
</select>

    <button onclick="limparFiltros()" class="btn-sm cancel">Limpar</button>
  </div>
</div>
<table>
<thead>
<tr>
<th>Filial</th><th>Raz√£o</th><th>NF</th><th>UF</th><th>Valor NF</th><th>Valor DT</th>
<th>Ve√≠culo</th><th>DT</th><th>Venc.</th><th>Cliente</th><th>Servi√ßo</th>
<th>Embutimento?</th><th>Motivo?</th><th>Fato Gerador</th><th>Observa√ß√µes</th>
<th>Status</th><th>Nota Prestador</th><th>Formul√°rio Custo</th><th>Racional Custo</th><th>A√ß√µes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</section>

</main>
</div>

<script>
let pastaHandle = null;
let pastaNome = '';  
let despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
let editRow = null;
const cadastro = document.getElementById('cadastro');
const despesasSec = document.getElementById('despesas');
const status = document.getElementById('status'); // <<< ESSENCIAL
  
function mostrar(id){
  cadastro.style.display='none';
  despesasSec.style.display='none';
  document.getElementById(id).style.display='block';
  if(id==='despesas') render();
}

function lerArquivo(file){
  return new Promise(res=>{
    if(!file) return res(null);
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

async function salvar(){
  if(!nfUnico.value){ alert('Informe o n√∫mero da NF'); return; }

  const dts = document.querySelectorAll('.dt-item');
  if(dts.length === 0){ alert('Informe os n√∫meros das DTs'); return; }

  if(!nota.files[0]){ alert('Anexe a nota fiscal'); return; }

  const valorTotal = parseFloat(valorNFS.value.replace(/\./g,'').replace(',','.')) || 0;
  const valorRateado = (valorTotal / dts.length).toFixed(2);

const n = nota.files[0] ? await salvarNaPasta(nota.files[0]) : null;
const p = compPag.files[0] ? await salvarNaPasta(compPag.files[0]) : null;
const ne = compNeg.files[0] ? await salvarNaPasta(compNeg.files[0]) : null;

  dts.forEach((inputDT, idx) => {
  despesas.push({
    filial: idx === 0 ? filial.value : '',
    razao: idx === 0 ? razao.value : '',
    nfCliente: idx === 0 ? nfUnico.value : '',
    uf: idx === 0 ? uf.value : '',
    valorNFS: idx === 0 ? valorTotal : '',
    valorDT: valorRateado,
    tipoVeiculo: idx === 0 ? tipoVeiculo.value : '',
    numeroDT: inputDT.value,
    dataVencimento: dataVencimento.value,   // sempre preenchido internamente
    cliente: idx === 0 ? cliente.value : '',
    tipoServico: tipoServico.value,          // manter para filtro
    embutimento: idx === 0 ? embutimento.value : '',
    motivo: idx === 0 ? motivo.value : '',
    fatoGerador: fatoGerador.value,          // manter para filtro
    observacoes: idx === 0 ? observacoes.value : '',
    status: idx === 0 ? status.value : '',
    nota: idx === 0 ? n : null,
    pag:  idx === 0 ? p : null,
    neg:  idx === 0 ? ne : null
  });
});
  
  localStorage.setItem('despesas', JSON.stringify(despesas));
  despesas = JSON.parse(localStorage.getItem('despesas') || '[]');

  mostrar('despesas');
  render();

  alert('Despesa salva com sucesso (rateada por DT)');
  novaDespesa();
}
  
function novaDespesa(){
  const campos = document.querySelectorAll('#cadastro input, #cadastro select');
  campos.forEach(c => { c.value = ''; });
  listaDT.innerHTML = '';
  razao.focus();
}
  
function editar(i){ editRow=i; render(); }
function cancelar(){ editRow=null; render(); }

function salvarLinha(i){
  const row = document.querySelectorAll('[data-row="'+i+'"]');

  const keys = [
    'filial','razao','nfCliente','uf','valorNFS','valorDT',
    'tipoVeiculo','numeroDT','dataVencimento','cliente',
    'tipoServico','embutimento','motivo','fatoGerador',
    'observacoes','status'
  ];

  let col = 0;
  keys.forEach(k=>{
    // Se n√£o existe campo na tela para essa coluna, n√£o altera o valor
    if(row[col]){
      despesas[i][k] = row[col].value;
      col++;
    }
  });

  recalcularGrupo(i);
  localStorage.setItem('despesas', JSON.stringify(despesas));
  editRow = null;
  render();
}

function excluir(i){
  if(confirm('Deseja excluir esta despesa?')){
    despesas.splice(i,1);
    localStorage.setItem('despesas',JSON.stringify(despesas));
    render();
  }
}

function cell(v,i){return `<input data-row="${i}" value="${v||''}">`}

function render(){
 tbody.innerHTML='';

const listaFiltrada = aplicarFiltros(despesas)
  .sort((a,b) => (a.dataVencimento || '').localeCompare(b.dataVencimento || ''));
  atualizarTotal(listaFiltrada);

let mesAtual = '';
let quinzenaAtual = '';

listaFiltrada.forEach((d,i)=>{
  const ma = mesAno(d.dataVencimento);
  const qz = quinzena(d.dataVencimento);

  // Quebra por M√äS
  if(ma !== mesAtual){
    mesAtual = ma;
    quinzenaAtual = '';
    tbody.innerHTML += `
      <tr>
       <td colspan="20" style="
  background:#020617;
  color:#38bdf8;
  font-weight:bold;
  padding:10px;
  text-align:left;
">
          ${ma || 'Sem data'}
        </td>
      </tr>
    `;
  }

  // Quebra por QUINZENA
  if(qz !== quinzenaAtual){
    quinzenaAtual = qz;
    tbody.innerHTML += `
      <tr>
        <td colspan="20" style="
  background:#0f172a;
  color:#a5f3fc;
  font-weight:bold;
  padding:8px 10px;
  text-align:left;
">
          ${qz}
        </td>
      </tr>
    `;
  }

  const edit = editRow===i;

  tbody.innerHTML+=`<tr>
<td>${edit?cell(d.filial,i):d.filial||''}</td>    
<td>${edit?cell(d.razao,i):d.razao||''}</td>
<td>${edit?cell(d.nfCliente,i):d.nfCliente||''}</td>
<td>${edit?cell(d.uf,i):d.uf||''}</td>
<td>${edit?cell(d.valorNFS,i) : moedaBR(d.valorNFS)}</td>
<td>${edit?cell(d.valorDT,i) : moedaBR(d.valorDT)}</td>
<td>${edit?cell(d.tipoVeiculo,i):d.tipoVeiculo||''}</td>
<td>${edit?cell(d.numeroDT,i):d.numeroDT||''}</td>
<td>${edit
  ? cell(d.dataVencimento,i)
  : (d.dataVencimento && d.nfCliente ? dataBR(d.dataVencimento) : '')
}</td>
<td>${edit?cell(d.cliente,i):d.cliente||''}</td>
<td>${edit?cell(d.tipoServico,i):d.tipoServico||''}</td>
<td>${edit?cell(d.embutimento,i):d.embutimento||''}</td>
<td>${edit?cell(d.motivo,i):d.motivo||''}</td>
<td>${edit?cell(d.fatoGerador,i):d.fatoGerador||''}</td>
<td>${edit?cell(d.observacoes,i):d.observacoes||''}</td>
<td>
${
  d.nfCliente && d.status && d.status.trim() !== ''
    ? (edit
        ? `<select data-row="${i}">
             <option ${d.status==='Pendente'?'selected':''}>Pendente</option>
             <option ${d.status==='Aprovado'?'selected':''}>Aprovado</option>
           </select>`
        : `<span class="badge ${d.status==='Aprovado'?'ok':'pending'}">${d.status}</span>`
      )
    : ''
}
</td>
<td>${d.nota?`<button class="btn-sm edit" onclick="abrirArquivo('${d.nota}')">Abrir</button>`:'-'}</td>
<td>${d.pag?`<button class="btn-sm edit" onclick="abrirArquivo('${d.pag}')">Abrir</button>`:'-'}</td>
<td>${d.neg?`<button class="btn-sm edit" onclick="abrirArquivo('${d.neg}')">Abrir</button>`:'-'}</td>
<td>
${edit?
`<button class="btn-sm save" onclick="salvarLinha(${i})">Salvar</button>
 <button class="btn-sm cancel" onclick="cancelar()">Cancelar</button>`:
`<button class="btn-sm edit" onclick="editar(${i})">Editar</button>
 <button class="btn-sm del" onclick="excluir(${i})">Excluir</button>`}
</td>
</tr>`;
});
}

function exportarExcel(){
  const lista = aplicarFiltros(despesas)
    .sort((a,b) => (a.dataVencimento || '').localeCompare(b.dataVencimento || ''));

  const dadosExcel = [];
  let mesAtual = '';
  let quinzenaAtual = '';

  lista.forEach(d => {
    const ma = mesAno(d.dataVencimento);
    const qz = quinzena(d.dataVencimento);

    if(ma !== mesAtual){
      mesAtual = ma;
      quinzenaAtual = '';
      dadosExcel.push({ Filial: `==== ${ma} ====` });
    }

    if(qz !== quinzenaAtual){
      quinzenaAtual = qz;
      dadosExcel.push({ Filial: `-- ${qz} --` });
    }

    dadosExcel.push({
      Filial: d.filial || '',
      Razao: d.razao || '',
      NF: d.nfCliente || '',
      UF: d.uf || '',
      Valor_NF: Number(d.valorNFS || 0),
      Valor_DT: Number(d.valorDT || 0),
      Veiculo: d.tipoVeiculo || '',
      DT: d.numeroDT || '',
      Vencimento: dataBR(d.dataVencimento),
      Cliente: d.cliente || '',
      Servico: d.tipoServico || '',
      Embutimento: d.embutimento || '',
      Motivo: d.motivo || '',
      Fato_Gerador: d.fatoGerador || '',
      Observacoes: d.observacoes || '',
      Status: d.status || '',
      Nota_Prestador: d.nota ? 'ANEXADO NO SISTEMA' : '',
      Formulario_Custo: d.pag ? 'ANEXADO NO SISTEMA' : '',
      Racional_Custo: d.neg ? 'ANEXADO NO SISTEMA' : ''
    });
  });

  const ws = XLSX.utils.json_to_sheet(dadosExcel);

  // For√ßa formato num√©rico com 2 casas decimais
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R = 1; R <= range.e.r; ++R){
    ['E','F'].forEach(col => { // E = Valor_NF, F = Valor_DT
      const cell = ws[col + (R+1)];
      if(cell && typeof cell.v === 'number'){
        cell.t = 'n';
        cell.z = '#,##0.00';
      }
    });
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Despesas");
  XLSX.writeFile(wb, "despesas.xlsx");
}
  
function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l","pt","a4");

  const lista = aplicarFiltros(despesas)
    .sort((a,b) => (a.dataVencimento || '').localeCompare(b.dataVencimento || ''));

  const body = [];
  let mesAtual = '';
  let quinzenaAtual = '';

  lista.forEach(d => {
    const ma = mesAno(d.dataVencimento);
    const qz = quinzena(d.dataVencimento);

    // Quebra por m√™s
    if(ma !== mesAtual){
      mesAtual = ma;
      quinzenaAtual = '';
      body.push([
        { content: ma || 'Sem data', colSpan: 20, styles:{fillColor:[15,23,42], textColor:[56,189,248], fontStyle:'bold'} }
      ]);
    }

    // Quebra por quinzena
    if(qz !== quinzenaAtual){
      quinzenaAtual = qz;
      body.push([
        { content: qz, colSpan: 20, styles:{fillColor:[2,6,23], textColor:[165,243,252], fontStyle:'bold'} }
      ]);
    }

    body.push([
      d.filial||'', d.razao||'', d.nfCliente||'', d.uf||'',
      moedaBR(d.valorNFS), moedaBR(d.valorDT), d.tipoVeiculo||'',
      d.numeroDT||'', dataBR(d.dataVencimento), d.cliente||'',
      d.tipoServico||'', d.embutimento||'', d.motivo||'',
      d.fatoGerador||'', d.observacoes||'', d.status||'',
      d.nota ? 'Abrir' : '',
      d.pag ? 'Abrir' : '',
      d.neg ? 'Abrir' : '',
      '' // a√ß√µes (vazio no PDF)
    ]);
  });

  doc.text("Relat√≥rio de Despesas", 40, 30);

  doc.autoTable({
    startY: 50,
    head: [[
      "Filial","Raz√£o","NF","UF","Valor NF","Valor DT","Ve√≠culo","DT",
      "Venc.","Cliente","Servi√ßo","Embut.","Motivo","Fato Gerador",
      "Obs.","Status","Nota","Form. Custo","Racional",""
    ]],
    body,
    styles:{ fontSize:7, cellPadding:3 },
    didDrawCell: function(data){
      const col = data.column.index;
      const row = data.row.raw;

      // Colunas de anexos: 16,17,18
      if([16,17,18].includes(col) && data.cell.text[0] === 'Abrir'){
        const idx = data.row.index;
        const registro = lista.filter(r => r.dataVencimento)[idx];

        let url = '';
        if(col===16) url = registro?.nota;
        if(col===17) url = registro?.pag;
        if(col===18) url = registro?.neg;

        if(url){
          doc.link(data.cell.x, data.cell.y, data.cell.width, data.cell.height, { url });
        }
      }
    }
  });

  doc.save("despesas.pdf");
}

function gerarCamposDT(){
  const qtd = parseInt(qtdDT.value || 0);
  listaDT.innerHTML = '';
  for(let i=1; i<=qtd; i++){
    listaDT.innerHTML += `
      <div style="margin-bottom:6px">
        <label>DT ${i}</label>
        <input class="dt-item" placeholder="Informe o n√∫mero da DT">
      </div>`;
  }
}
  
 async function abrirArquivo(nomeArquivo){
  if(!pastaHandle){
    alert('Selecione primeiro a pasta de anexos.');
    return;
  }

  try{
    const handle = await pastaHandle.getFileHandle(nomeArquivo);
    const file = await handle.getFile();
    const url = URL.createObjectURL(file);
    window.open(url, '_blank');
  }catch(e){
    alert('Arquivo n√£o encontrado na pasta.');
  }
}

  function formatarMoeda(campo){
  let v = campo.value.replace(/\D/g, '');
  v = (Number(v) / 100).toFixed(2);
  campo.value = v.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function moedaBR(v){
  if(v===null || v===undefined || v==='') return '';
  return Number(v)
    .toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 })
    .replace(/^/, 'R$');
}

function dataBR(data){
  if(!data) return '';
  const [y,m,d] = data.split('-');
  return `${d}/${m}/${y}`;
}

 function aplicarFiltros(lista){
  const fIni = filtroDataIni.value;
  const fFim = filtroDataFim.value;
  const fFilial = filtroFilial.value;
  const fServico = filtroServico.value;
  const fFato = filtroFato.value;
  const fMes = filtroMes.value;
  const fQuinzena = filtroQuinzena.value;

  return lista.filter(d => {
    if(!d.dataVencimento) return false;

    const [y,m,dia] = d.dataVencimento.split('-');
    const diaNum = parseInt(dia);
    const quinzena = diaNum <= 15 ? '1' : '2';

    if(fIni && d.dataVencimento < fIni) return false;
    if(fFim && d.dataVencimento > fFim) return false;
    if(fFilial && d.filial !== fFilial) return false;
    if(fServico && d.tipoServico !== fServico) return false;
    if(fFato && d.fatoGerador !== fFato) return false;
    if(fMes && m !== fMes) return false;
    if(fQuinzena && quinzena !== fQuinzena) return false;

    return true;
  });
}

function limparFiltros(){
  filtroDataIni.value = '';
  filtroDataFim.value = '';
  filtroFilial.value = '';
  filtroServico.value = '';
  filtroFato.value = '';
  filtroMes.value = '';
  filtroQuinzena.value = '';
  render();
}

  function mesAno(data){
  if(!data) return '';
  const [y,m] = data.split('-');
  return `${m}/${y}`;
}

function quinzena(data){
  if(!data) return '';
  const dia = parseInt(data.split('-')[2]);
  return dia <= 15 ? '1¬∞ quinzena' : '2¬∞ quinzena';
}

  function atualizarTotal(lista){
  let soma = 0;
  lista.forEach(d => {
    const v = parseFloat(d.valorNFS || 0);
    if(!isNaN(v)) soma += v;
  });

  document.getElementById('totalValorNF').textContent = 
    soma.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
}

function recalcularGrupo(indexLinha) {
  // achar a linha "pai" (onde tem NF)
  let i = indexLinha;
  while(i >= 0 && !despesas[i].nfCliente){
    i--;
  }
  if(i < 0) return;

  const nfBase = despesas[i].nfCliente;

  // pegar todas as linhas desse grupo
  const grupo = [];
  for(let j = i; j < despesas.length; j++){
    if(j === i || !despesas[j].nfCliente){
      grupo.push(j);
    } else {
      break; // come√ßou outra NF
    }
  }

  // somar os valores DT
  let soma = 0;
  grupo.forEach(idx => {
    const v = parseFloat(despesas[idx].valorDT || 0);
    if(!isNaN(v)) soma += v;
  });

  // atualizar valor NF na primeira linha
  despesas[i].valorNFS = soma.toFixed(2);

  localStorage.setItem('despesas', JSON.stringify(despesas));
}

  async function escolherPasta(){
  try{
    pastaHandle = await window.showDirectoryPicker();
    pastaNome = pastaHandle.name;
    document.getElementById('pastaInfo').textContent = 'Pasta: ' + pastaNome;
  }catch(e){
    alert('Pasta n√£o selecionada.');
  }
}

async function salvarNaPasta(file){
  if(!pastaHandle) return null;

  const handle = await pastaHandle.getFileHandle(file.name, { create:true });
  const writable = await handle.createWritable();
  await writable.write(file);
  await writable.close();

  return file.name; // s√≥ salva o nome
}
  
</script>
</body>
</html>
